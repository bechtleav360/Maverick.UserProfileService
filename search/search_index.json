{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Opening remarks","text":"<p>Welcome to the UserProfileService (abbreviated: UPS) documentation. It should provide you with all necessary information to work with this powerful service.</p>"},{"location":"#what-is-the-userprofileservice","title":"What is the UserProfileService?","text":"<p>The  UPS is a system designed to manage user data and related entities such as groups, organizations, roles, or functions.  It consists of three main components:</p> <ol> <li> <p>Service: The UPS provides a comprehensive API that allows users to modify entities In this context, \"modify\" refers to performing CRUD (Create, Read, Update, Delete) operations. This API likely includes endpoints for actions such as creating, updating, deleting, and querying user profiles, groups, organizations, roles, and functions.</p> </li> <li> <p>Saga Worker: This component is responsible for validating and creating or modifying entities based on the requests received through the API. It handles business logic, data validation, and ensures consistency and integrity of the data. The Saga Worker can be considered the centerpiece of the UPS.</p> </li> <li> <p>Sync Service: The Sync Service is used to synchronize entities from a third-party system, specifically LDAP (Lightweight Directory Access Protocol) systems in this case. This component facilitates the synchronization of user data and related entities between the UPS and LDAP systems.</p> </li> </ol> <p>The UPS provides a wide range of functionality that will be explained further in this documenation.</p>"},{"location":"#history-motivation","title":"History / Motivation","text":""},{"location":"#bmbf-project","title":"BMBF-Project","text":"<p>\"Das Bundesministerium f\u00fcr Bildung und Forschung (BMBF) unterst\u00fctzt die Durchf\u00fchrung von Forschungs- und Innovationsprojekten im Rahmen von themenspezifischen und in themenoffenen F\u00f6rderprogrammen. Das breite F\u00f6rderangebot ist auf wichtige Innovations- oder Technologiefelder, aber auch auf unterschiedliche Herausforderungen und Ausgangsbedingungen zugeschnitten. Dabei werden insbesondere innovative kleine und mittlere Unternehmen (KMU) mit spezifischen F\u00f6rderprogrammen adressiert.\" (Quelle - Bundesministerium f\u00fcr Bildung und Forschung)</p> <p>Translation: The Federal Ministry of Education and Research (BMBF) supports the implementation of research and innovation projects within topic-specific and open-topic funding programs. The broad range of funding is tailored to important innovation or technology fields, as well as various challenges and starting conditions. In particular, innovative small and medium-sized enterprises (SMEs) are addressed with specific funding programs.</p> <p>\"Im Zuge der F\u00f6rderung entstand das Projekt E365 Maverick. Es ist ein durch das BMBF gef\u00f6rdertes Forschungsprojekt, welches im Rahmen einer Kooperation zwischen Bechtle AG und Hochschule Bonn-Rhein-Sieg durchgef\u00fchrt wird. Es bettet sich in die \u00fcbergeordnete Initiative \u201eNationale Bildungsplattform\u201c des BMBF ein.\" (Quelle - E365 Maverick Projekt) </p> <p>Translation: As part of the funding, the project E365 Maverick was created. It is a research project funded by the BMBF, which is being conducted in cooperation between Bechtle AG and the Bonn-Rhein-Sieg University of Applied Sciences. It is embedded within the overarching initiative 'National Education Platform' of the BMBF.</p>"},{"location":"#splitting-the-ups","title":"Splitting the UPS","text":"<p>Bechtle provides the UPS, which is intended for user data within the digital education platform. Since GitHub is the largest host of open-source projects, the UPS is made available on this platform. Furthermore, the community within the host is very active, leading to an increase in software quality. Improvements can be noted and discussed by the community, largely ensuring a continuous development of the software with the latest technologies and design patterns.</p> <p>As the current code base of the UPS is currently in an internal project within Azure DevOps Services, this will continue to be used for the customer-specific part.</p>"},{"location":"Architecture/Data%20Model/","title":"Data-Models","text":"<p>The following core entities can currently be created or managed by the service:</p> <ol> <li>Users: User information related to an individual is stored, including their first name, last name, and other personal data.</li> <li>Groups: Information about a group is stored (name, members, etc.). Multiple users can be grouped together in a group to, for example, assign specific rights to a number of users.</li> <li>Organizations: Organizational data is stored.</li> <li>Roles: Information about roles is stored. Roles can be used to assign specific rights to users, allowing access to files/operations.</li> <li>Functions: A function consists of a tuple, namely a role and an organizational unit. It determines which rights are assigned to a user or a group. If your organization, for example, is named <code>Department for Airplanes</code> and your role is <code>read</code>, then the name of the function would be <code>Department for Airplanes read</code>. In this case, you would only have <code>read</code> as a permission.</li> </ol>"},{"location":"Architecture/Main%20Architecture/","title":"Main Architecture","text":"<p>The UserProfileService consists of three main components:</p>"},{"location":"Architecture/Main%20Architecture/#userprofileserviceapi","title":"UserProfileService.API","text":"<p>This is an interface accessible through public networks, specifically a RestAPI with numerous endpoints designed for managing profile entities.</p>"},{"location":"Architecture/Main%20Architecture/#userprofileservicesagaworker","title":"UserProfileService.SagaWorker","text":"<p>This system operates behind the scenes, carrying out commands triggered by the API or Sync processes. It validates and modifies data, and also monitors queues. Due to its nature, it is not meant to be publicly accessible. For security purposes, its endpoints should be restricted behind a firewall or within an internal network.</p>"},{"location":"Architecture/Main%20Architecture/#userprofileservicesync","title":"UserProfileService.Sync","text":"<p>It facilitates the synchronization of data from external sources with the data currently stored. Currently, we have implemented an LDAP connector as one of these external sources.</p>"},{"location":"Architecture/Main%20Architecture/#the-architecture","title":"The Architecture","text":"<p>The picture illustrates the comprehensive architecture of the UPS system. Clients can request entities stored in the database. The UPS API then retrieves these entities directly from ArangoDB. The models are stored in the database in the format required by the program, minimizing the need for significant transformations when they are returned.</p> <p>The Client also has the capability to create an entity, such as a group. When a request is made, the API processes the request and returns a ticket as described below. The API then places a command into a queue that is connected to the SagaWorker. The SagaWorker receives the command and performs the following steps:</p> <ol> <li> <p>Receives the GroupCreate message.</p> </li> <li> <p>Validates the group.</p> </li> <li> <p>Stores the group in the EventStore, a centralized database for storing events. We utilize the PostgreSQL database along with Marten for this purpose.</p> </li> <li> <p>Projects the group into the Arango database.</p> </li> </ol> <p>If the validation of the group or the storing in the EventStore fails, the entire process will be aborted and reversed.</p>"},{"location":"Architecture/Main%20Architecture/#ups-sync","title":"UPS-Sync","text":"<p>It is also noted that UPS-Sync can synchronize entities from an external source, currently limited to LDAP systems. UPS-Sync uses Redis to temporarily store entities that need synchronization. The Sync module then sends messages to the queue, where the SagaWorker listens and creates the necessary entities in the database. Once an entity is created, the Sync module receives a confirmation message.UPS-Sync can thus keep track of the synchronized entities.</p>"},{"location":"For%20Developer/API/Datastructure/","title":"Datastructure","text":"<p>The UPS data is currently stored in ArangoDB, a graph database that supports graph queries. Data is stored as JSON strings, and ArangoDB offers two types of data structures for storage: Collections and EdgeCollections. Collections store JSON documents. Each document can have varying fields and structures. EdgeCollections are a specialized data store in ArangoDB used for storing relationships between documents in a graph. They enable the definition of directed or undirected edges between nodes.</p>"},{"location":"For%20Developer/API/Datastructure/#used-collections-edgecollections","title":"Used Collections / EdgeCollections","text":"<p>The service utilizes all collections with the suffix Service_. All data accessible via the API is stored in these collections. To comprehend the collections and their models, refer to the Data Model and managed entities documentation. Further details about these collections will be provided in the documentation.</p>"},{"location":"For%20Developer/API/Datastructure/#service_clientsettingsquery","title":"Service_clientSettingsQuery","text":"<p>The client settings are also represented as key-value pairs. In addition to custom properties, client settings can be inherited. They can only be used for users and groups. Groups are containers that can be assigned to each other, allowing you to create a hierarchy. Let's first take a look at this example.</p> <p></p> <p>The example illustrates groups that are assigned to each other, with users being assigned to these groups. Both entities contain client settings, all of which are inherited in this example. The group <code>Bechtle</code> has client settings that define the <code>IDE</code> used by users in the company. Similarly, the group 'SH Bonn' also has client settings with the same key (<code>IDE</code>). Consequently, the client settings from the 'Bechtle' group are overwritten. As a result, the user <code>Andreas Minz</code>, inheriting client settings from the 'SH Bonn' group, will use the Vim editor as their IDE. </p> <p>In general, client settings are combined when there are multiple instances. Therefore, both the IDE and the OS client settings will be merged. For example, the user 'Max Mustermann' will use Linux as his  OS, as the client settings from the 'AVS' group will overwrite others. However, Max inherits the IDE settings from the 'SH-Bonn' group. On the other hand, the user 'Sandy Musterfrau' will use Windows 11 as her OS because she inherits it from the 'AVS' group. Nonetheless, her IDE setting will be overridden by her specific client settings, so she uses Visual Studio as her IDE.</p> <p>In summary, inherited client settings are sourced from higher levels and can be overwritten. When multiple client settings exist, they are combined.</p> <p>The client settings may appear like this:</p> Client settings example <pre><code>{\n  \"IsInherited\": true,\n  \"Kind\": \"User\",\n  \"ProfileId\": \"b2aba1cc-0d86-4056-9358-594a560baae9\",\n  \"SettingsKey\": \"OS\",\n  \"UpdatedAt\": \"0001-01-01T00:00:00Z\",\n  \"Value\": {\n    \"data\": [\"Windows\"]\n  }\n}\n</code></pre> <ul> <li><code>IsInherited</code>: Indicates whether the client setting is inherited.</li> <li><code>Kind</code>: Denotes the type of profile associated with the client setting.</li> <li><code>ProfileId</code>: Represents the Id of the profile associated with the client setting.</li> <li><code>SettingsKey</code>: Identifies the key of the client setting.</li> <li><code>UpdatedAt</code>: Specifies when the client setting was last updated.</li> <li><code>Value</code>: Represents the value of the client setting.</li> </ul>"},{"location":"For%20Developer/API/Datastructure/#service_custompropertiesquery","title":"Service_customPropertiesQuery","text":"<p>The collections store custom properties for specific users, group or an organization. A custom property consists of a key-value pair, which can be used to add additional information to an entity. The data model for this can look like following:</p> Custom property example <pre><code>{\n  \"Related\": \"Service_profilesQuery/6ad843e6-b3cd-457f-b205-33a5813c3c53\",\n  \"Key\": \"FavoriteColor\",\n  \"Value\": \"Green\"\n}\n</code></pre> <ul> <li> <p><code>Related</code>- The profile the custom property is added to (user, group or organization)</p> </li> <li> <p><code>Key</code> - The key of the custom property</p> </li> <li> <p><code>Value</code> - The value of the custom property</p> </li> </ul>"},{"location":"For%20Developer/API/Datastructure/#service_pathtree","title":"Service_pathTree","text":"<p>The path tree contains every profile that has assignments to another profile. This means that for a single profile, we have all the assignments necessary to retrieve its members. Nowadays, we are not using the Path-Tree. It is used to compute the Path of an profile. An Example how an item can look like:</p> Service path tree example <pre><code>{\n  \"RelatedProfileId\": \"b5f59454-be26-4035-b1d8-5cfacbc518a4\",\n  \"ObjectId\": \"b5f59454-be26-4035-b1d8-5cfacbc518a4\",\n  \"Tags\": []\n}\n</code></pre> <ul> <li> <p><code>RelatedProfileId</code> - The Id of the profile for which the member will be retrieved.</p> </li> <li> <p><code>ObjectId</code> - The object to which the item is assigned.</p> </li> <li> <p><code>Tags</code> - The list of tags associated with the profile.</p> </li> </ul> <p>If the <code>RelatedProfileId</code> and <code>ObjectId</code> have the same value, it represents the profile itself. If both values differ, it means that the profile with the <code>RelatedProfileId</code> has a member with an ID shown in the <code>ObjectId</code>. Both documents, whether their Ids are the same or different, are connected via an edge, with the connection stored in the <code>Service_pathTreeEdges</code> collection.</p>"},{"location":"For%20Developer/API/Datastructure/#service_pathtreeedges","title":"Service_pathTreeEdges","text":"<p>The collection stores the edges that connect the pathTree documents. Each edge collection contains a <code>_to</code> and <code>_from</code> attribute that are fixed. The <code>From</code> and <code>To</code> attributes contain the exact IDs of a pathTree. Each document has a <code>_key</code> property that uniquely identifies a document within the collection. The <code>_id</code> is also a property specific to ArangoDB; it completely identifies a document in a database. Typically, it consists of the collection name and the <code>_key</code> property, such as \"Service_pathTree/10de9702-990a-4cec-91b7-91e622a23ba1\". In the body of the edge, we have conditions, also known as ranged conditions, that will be explained here. The _from and _to fields connect two path documents. As an example, we list the two pathTree documents and the edge. The IDs are typically GUIDs, but for simplicity, we chose easy-to-obtain numbers:</p>"},{"location":"For%20Developer/API/Datastructure/#pathtree-documents","title":"PathTree-Documents","text":"Path tree documents example <pre><code>{\n  \"RelatedProfileId\": \"123\",\n  \"ObjectId\": \"123\",\n  \"Tags\": [],\n  \"_id:\":\"Service_pathTree/45\",\n  \"_key\":\"45\"\n}\n\n{\n  \"RelatedProfileId\": \"123\",\n  \"ObjectId\": \"456\",\n  \"Tags\": [],\n  \"_id:\":\"Service_pathTree/46\",\n  \"_key\":\"46\"\n}\n</code></pre>"},{"location":"For%20Developer/API/Datastructure/#edge-connection-the-documents","title":"Edge Connection the documents","text":"<ul> <li> <p><code>_from</code> - Service_pathTree/45</p> </li> <li> <p><code>_to</code> - Service_pathTree/46</p> </li> </ul> Path tree connection example <pre><code>{\n  \"Conditions\": [\n    {\n      \"Start\": null,\n      \"End\": null\n    }\n  ],\n  \"RelatedProfileId\": \"123\"\n}\n</code></pre> <p>So, the two documents <code>Service_pathTree/45</code> and <code>Service_pathTree/46</code> are now connected via the edge. Through a graph query across these collections, we can determine which profile has assignments. This can be used to retrieve all users who have active assignments to a group or a function.</p>"},{"location":"For%20Developer/API/Datastructure/#service_profilesquery","title":"Service_profilesQuery","text":"<p>The <code>Service_profiles</code> collection stores profiles along with their relationships to other profiles. Within this collection, users, organizations, and groups are stored. An example user entry might look like this:</p> User profile example <pre><code>{\n  \"FunctionalAccessRights\": null,\n  \"MemberOf\": [],\n  \"SecurityAssignments\": [],\n  \"Paths\": [],\n  \"Tags\": [],\n  \"CustomPropertyUrl\": null,\n  \"UserName\": \"andreas.mustermann\",\n  \"FirstName\": \"Andreas\",\n  \"LastName\": \"Mustermann\",\n  \"Email\": \"andreas.mustermann@gmx.de\",\n  \"ImageUrl\": null,\n  \"UserStatus\": null,\n  \"Id\": \"6d78353b-5ff6-4314-aae6-50700afa7295\",\n  \"Name\": \"Andreas Mustermann\",\n  \"DisplayName\": \"Andreas Hinz\",\n  \"Kind\": \"User\",\n  \"CreatedAt\": \"2023-01-02T19:15:09.9954893Z\",\n  \"UpdatedAt\": \"2024-02-29T10:51:12.7416251Z\",\n  \"TagUrl\": null,\n  \"SynchronizedAt\": null,\n  \"Source\": \"Ldap\",\n  \"Domain\": \"ad.example.org\",\n  \"ExternalIds\": [\n    {\n      \"Id\": \"S-1-5-21-966539559-2079964620-3194842515-3311\",\n      \"IsConverted\": false,\n      \"Source\": \"Ldap\"\n    }\n  ]\n}\n</code></pre> <p>Most attributes are self-explanatory, such as <code>UserName</code>, <code>FirstName</code>, <code>LastName</code>, <code>Email</code>, <code>Id</code>, <code>Name</code>, <code>DisplayName</code>, <code>CreatedAt</code>, and <code>UpdatedAt</code>.</p> <ul> <li> <p><code>MemberOf</code>: Represents the groups or organizations to which the profile belongs. For example, a user can be a member of a group.</p> </li> <li> <p><code>SecurityAssignments</code>: Refers to the functions or roles assigned to the profile for security purposes.</p> </li> <li> <p><code>Paths</code>: Contains the path to all active assignments associated with the profile.</p> </li> <li> <p><code>Tags</code>: Represents the tags assigned to the profile.</p> </li> <li> <p><code>CustomPropertyUrl</code>: Provides a link where custom properties associated with the profile can be found.</p> </li> <li> <p><code>ImageUrl</code>: Stores a link to where the user's image is stored, although this functionality is currently not implemented.</p> </li> <li> <p><code>UserStatus</code>: Indicates the status for a specific profile.</p> </li> <li> <p><code>Kind</code>: Specifies the type of profile, such as user, group, or organization.</p> </li> <li> <p><code>Source</code>: Defines the source from which the profile was created, such as an LDAP source in this case.</p> </li> <li> <p><code>Domain</code>: Represents the domain of the user, particularly useful when synchronizing users from LDAP.</p> </li> <li> <p><code>ExternalIds</code>: Holds the external IDs from an external system, such as LDAP. The <code>IsConverted</code> parameter is optional and indicates whether the profile has been converted. A profile may have multiple external IDs if stored in multiple sources.</p> </li> </ul> <p>This entities can be retrieved via Endpoints that the user profile service provides.</p>"},{"location":"For%20Developer/API/Datastructure/#service_rolesfunctionsquery","title":"Service_rolesFunctionsQuery","text":"<p>This collection stores the roles and functions. A function can be looked like this:</p> Service role/function example <pre><code>{\n  \"Conditions\": null,\n  \"LinkedProfiles\": [],\n  \"Id\": \"65525461-aad5-4a79-95df-b64ce54fe978\",\n  \"Name\": \"Z20 Administration\",\n  \"Type\": \"Function\",\n  \"OrganizationId\": \"629c6a09-7c5f-40bd-b1aa-a31667c26511\",\n  \"Organization\": {\n      ...\n  },\n  \"Role\": {\n    ...\n  },\n  \"RoleId\": \"83fdde77-a78c-4b04-80c6-2221991cf909\",\n  \"CreatedAt\": \"2021-10-04T09:41:53.0954287Z\",\n  \"UpdatedAt\": \"2021-10-04T09:41:53.0954287Z\",\n  \"SynchronizedAt\": null,\n  \"Source\": \"Api\",\n  \"ExternalIds\": []\n}\n</code></pre> <p>A function consists of a role and an organization, although the organization is not shown in the JSON.</p> <ul> <li><code>LinkedProfiles</code>: Represents the linked profiles associated with the function.</li> <li><code>Type</code>: Indicates the type of entity stored in the collection, with possible values being <code>Function</code> or <code>Role</code>.</li> <li><code>Source</code>: Specifies the source from which the function was created.</li> </ul>"},{"location":"For%20Developer/API/Datastructure/#service_tagsquery","title":"Service_tagsQuery","text":"<p>This collections store tags that are associated with an entity. Tags can be look like this:</p> Tag example <pre><code>{\n  \"Id\": \"916f7364-bf20-4086-84bd-34033d3a5011\",\n  \"Name\": \"Green\",\n  \"Type\": \"Custom\"\n}\n</code></pre> <ul> <li><code>Id</code>: The ID of the tag.</li> <li><code>Name</code>: The name of the tag.</li> <li><code>Type</code>: Specifies the type of the tags, which can be:<ul> <li><code>Security</code>: Used for security-related tags that determine permissions.</li> <li><code>Custom</code>: Used for custom tags that have no functional impact but are for marking purposes.</li> <li><code>FunctionalAccessRights</code>: Primarily for internal use and not critical for functionality.</li> <li><code>Color</code>: Stores color information, typically inheritable and stored as tags.</li> </ul> </li> </ul>"},{"location":"For%20Developer/API/Datastructure/#service_tickets","title":"Service_tickets","text":"<p>The collection stores the service ticket when an entity is created, updated, or deleted. This will be explained here.</p>"},{"location":"For%20Developer/API/RangeConditions/","title":"Range Conditions","text":"<p>You can assign entities to each other in the user profile service. Each assignment has a <code>condition</code> that determines when the assignment is valid. A <code>condition</code> has two properties: <code>start</code> and <code>end</code>. Assignments can have multiple conditions. Conditions can be used to create assignments either in the present or in the future. For example, if a user needs a special privilege in two months within a specific group, you can create a condition for that time period. Alternatively, the user might only need the privilege for a certain duration. </p> <p>The keyword <code>null</code> holds a specific significance for the two properties in a condition. It indicates that the time range is either unlimited or irrelevant. If you set both properties to <code>null</code>, it signifies that the assignment is valid from its inception and has no end date. When you set the start as <code>null</code> and specify a future date, it indicates that the condition is valid from the present until the specified end date. Alternatively, you can set the <code>start</code> to a specific future date and leave the <code>end</code> as <code>null</code>, signifying that the assignment will commence at that future date and remain valid indefinitely.</p> <p>In the system, it's not possible to create conditions in the past, and they must not overlap temporally, as the validation process prevents this.</p>"},{"location":"For%20Developer/API/RangeConditions/#examples","title":"Examples","text":"<pre><code>{\n  \"conditions\": [\n    {\n      \"end\": null,\n      \"start\": null\n    }\n  ]\n}\n</code></pre> <p>The assignment starts immediately and lasts indefinitely.</p> <p><pre><code>{\n  \"conditions\": [\n    {\n      \"end\": \"2099-05-02T12:55:19.830Z\",\n      \"start\": null\n    }\n  ]\n}\n</code></pre> The assignment starts immediately and continues until May 2099.</p> <p><pre><code>{\n  \"conditions\": [\n    {\n      \"end\": null,\n      \"start\": \"2099-05-02T12:55:19.830Z\"\n    }\n  ]\n}\n</code></pre> The assignment begins in May 2099 and is permanent.</p> <p><pre><code>{\n  \"conditions\": [\n    {\n      \"end\": \"2102-05-02T12:55:19.830Z\",\n      \"start\": \"2099-05-02T12:55:19.830Z\"\n    }\n  ]\n}\n</code></pre> The assignment begins in May 2099 and ends in May 2102.</p> <p><pre><code>{\n  \"conditions\": [\n    {\n      \"start\": \"2024-06-01\",\n      \"end\": \"2024-06-30\"\n    },\n    {\n      \"start\": \"2024-06-15\",\n      \"end\": \"2024-07-15\"\n    }\n  ]\n}\n</code></pre> In this example, the two conditions overlap. The first condition is valid from June 1, 2024, to June 30, 2024, while the second condition is valid from June 15, 2024, to July 15, 2024, overlapping with the first one. The validation will fail.</p> <pre><code>{\n  \"conditions\": [\n    {\n      \"start\": \"2024-08-01\",\n      \"end\": \"2024-08-31\"\n    },\n    {\n      \"start\": \"2024-09-01\",\n      \"end\": \"2024-09-30\"\n    },\n    {\n      \"start\": \"2024-10-01\",\n      \"end\": \"2024-10-31\"\n    }\n  ]\n}\n</code></pre> <p>In this example, the conditions are clearly separated and all lie in the future without overlapping. The first condition is valid from August 1, 2024, to August 31, 2024, the second condition from September 1, 2024, to September 30, 2024, and the third condition from October 1, 2024, to October 31, 2024.</p>"},{"location":"For%20Developer/API/Service/","title":"Service","text":"<p>The Service or the API-Service is the interface for you to interact with the UPS. It provides a wide range of CRUD operations to manipulate currently available entities.</p>"},{"location":"For%20Developer/API/Service/#handling-entity-operations","title":"Handling Entity Operations","text":"<p>The Service utilizes the Asynchronous Request-Reply Pattern.The benefit of this pattern is that requests are handled asynchronously. Only operations that manipulate a entity are handled by this pattern.</p> <p>When an entity is created, deleted, or updated, a 202 (Accepted) HTTP response code is received, along with a location link in the header. This link allows tracking the progress of the operation. If the entity is not yet ready, a 202 (Accepted) HTTP status code is returned. Upon completion of the operation, the location link is redirected using a 302 (Redirect) HTTP code to the corresponding resource. This approach offers a significant advantage: the service can efficiently handle a high volume of requests simultaneously, while GET requests are processed as usual.</p>"},{"location":"For%20Developer/API/Service/#operation-progess","title":"Operation progess","text":"<p>Here we are creating a group. When the operation is triggered, the outcome appears as follows:</p> Operation progess example output <pre><code>{\n\"additionalQueryParameter\": null,\n\"details\": null,\n\"initiator\": \"\",\n\"objectIds\": [],\n\"operation\": \"CreateGroupProfile\",\n\"correlationId\": \"00-6b1bd2f59cecbaf31bde3734916e75ef-0eea74be7239fe11-01\",\n\"errorCode\": 0,\n\"errorMessage\": null,\n\"finished\": \"0001-01-01T00:00:00Z\",\n\"id\": \"6978c11f-b670-4a19-a139-994f4f423c25\",\n\"started\": \"2024-04-12T12:21:17.9407143Z\",\n\"status\": \"Pending\",\n\"type\": \"OperationTicket\"\n}\n</code></pre> <p>The operation has been registered in the service and will be processed shortly.</p> <p>When the operation has been processed:</p> Operation proccessed successfully example <pre><code>{\n\"memberOf\": [],\n\"members\": [],\n\"customPropertyUrl\": \"https://userprofile.de/api/v2/profiles/6368956b-56b0-4878-8afc-874c2aadf521/customProperties\",\n\"createdAt\": \"2024-04-12T12:21:20.7407143Z\",\n\"displayName\": \"AdministrationGroup\",\n\"externalIds\": [],\n\"id\": \"6368956b-56b0-4878-8afc-874c2aadf521\",\n\"imageUrl\": \"https://userprofile.de/api/v2/profiles/6368956b-56b0-4878-8afc-874c2aadf521/image\",\n\"isMarkedForDeletion\": false,\n\"isSystem\": false,\n\"kind\": \"Group\",\n\"name\": \"AdministrationGroup\",\n\"source\": \"Api\",\n\"synchronizedAt\": null,\n\"tagUrl\": \"https://userprofile.de/api/v2/groups/6368956b-56b0-4878-8afc-874c2aadf521/tags\",\n\"updatedAt\": \"2024-04-12T12:21:20.7407143Z\",\n\"weight\": 0\n}\n</code></pre> <p>The operation has been processed, and the entity is now stored in the database. The link is now directing to the current state of the entity stored in the database.</p>"},{"location":"For%20Developer/API/Service/#get-operations","title":"GET Operations","text":"<p>The GET operations are handled synchronously. If you need to request a large amount of data, the results may be paginated. This means that the result will contain a 'next' link, allowing you to retrieve the next batch or page of items. This approach ensures that you don't need to request a large number of items all at once.</p> <p>Result Page for groups:</p> Result page example output <pre><code>{\n  \"response\": {\n    \"count\": 1499,\n    \"nextLink\": \"https://userprofile.de/api/v2/groups?Limit=10&amp;Offset=10\",\n    \"previousLink\": \"\"\n  },\n  \"result\": [\n    {\n      \"createdAt\": \"2023-03-24T13:45:00.4246881Z\",\n      \"displayName\": \"0001_Gruppe\",\n      \"externalIds\": [\n        {\n          \"id\": \"a517f195-1975-4e79-8890-4c32db938cb5\",\n          \"isConverted\": false,\n          \"source\": \"Bonnea\"\n        }\n      ]\n    }\n  ]\n}\n</code></pre> <p>In this scenario, the 'next' link will fetch the next 10 groups of items. The batch size can be chosen according to preference.</p>"},{"location":"For%20Developer/API/Service/#dependencies","title":"Dependencies","text":"<p>The Service relies on the Saga Worker to perform entity creation, updating, or deletion operations. Without the Service, no manipulation operations are possible. It's crucial to avoid this common error by ensuring the availability and proper functioning of the Saga Worker.</p>"},{"location":"For%20Developer/API/TicketStore/","title":"Tickestore","text":"<p>The ticket store manages requests to the UPS API and oversees their progress. It specifically handles create, delete, and update operations. For instance, when an entity is created, a corresponding ticket is generated in the Ticket Store under <code>Service_tickets</code>. Here's an example of how a ticket that has been created might appear:</p> Ticket example output <pre><code>{\n  \"additionalQueryParameter\": null,\n  \"details\": null,\n  \"initiator\": \"\",\n  \"objectIds\": [],\n  \"operation\": \"CreateGroupProfile\",\n  \"correlationId\": \"00-889bac6d8676c2135354f2d66d9e2dc3-8d76f793dc0310f7-01\",\n  \"errorCode\": 0,\n  \"errorMessage\": null,\n  \"finished\": \"0001-01-01T00:00:00Z\",\n  \"id\": \"960a0bf3-cb3c-4d44-88c7-f8f243e15838\",\n  \"started\": \"2024-04-25T11:51:38.3868863Z\",\n  \"status\": \"Pending\",\n  \"type\": \"OperationTicket\"\n}\n</code></pre> <ul> <li> <p><code>additionalQueryParameter</code>: Sometimes needed for special query parameters (for redirecting to specific entities).</p> </li> <li> <p><code>details</code>: Specifies the details of the problem that occurred.</p> </li> <li> <p><code>initiator</code>: Specifies the ID of the user who initiated the operation. Can be null if the initiator is unknown.</p> </li> <li> <p><code>objectIds</code>: The IDs of the objects that will be processed.</p> </li> <li> <p><code>operation</code>: The operation that is currently being processed.</p> </li> <li> <p><code>correlationId</code>: The correlation ID for the request. This ID is needed to trace the operation if an error occurs.</p> </li> <li> <p><code>errorCode</code>: A code indicating the error that occurred. It will be 0 if none occurred.</p> </li> <li> <p><code>errorMessage</code>: A message describing the error that occurred. It will be null if none occurred.</p> </li> <li> <p><code>finished</code>: The timestamp when the ticket was finished.</p> </li> <li> <p><code>id</code>: The ID of the ticket.</p> </li> <li> <p><code>started</code>: The timestamp when the ticket was started.</p> </li> <li> <p><code>status</code>: The status of the current ticket.</p> </li> <li> <p><code>type</code>: The type of the ticket.</p> </li> </ul> <p>When the ticket is completed without any errors, the <code>status</code> property changes to <code>completed</code>, and <code>finished</code> receives the timestamp when the operation was finished.</p>"},{"location":"For%20Developer/API/TicketStore/#errorhandling","title":"ErrorHandling","text":"<p>Typically, most operations are processed without errors. However, as with most systems, errors can occur from time to time. When an error occurs, the operation is not processed, and the manipulation with the entity does not take place. The ticket then contains information about the type of error that occurred, allowing you to investigate it further. An error might look like this:</p> Ticket error handling example output <pre><code>  {\n    \"ObjectIds\": [\n      \"8c63141d-109b-47d0-ab06-f57b9833c481\"\n    ],\n    \"Operation\": \"CreateCustomPropertiesForProfile\",\n    \"Details\": {\n      \"Type\": null,\n      \"Title\": \"Unable to complete the operation\",\n      \"Status\": 400,\n      \"Detail\": \"Validation failed.\",\n      \"Instance\": null,\n      \"Extensions\": {\n        \"StatusCode\": \"BadRequest\",\n        \"ValidationResults\": [\n          {\n            \"Member\": \"ResourceId\",\n            \"ErrorMessage\": \n            \"Profile with id '8c63141d-109b-47d0-ab06-f57b9833c481' and \n            kind 'Unknown' does not exists.\",\n            \"AdditionalInformation\": null\n          }\n        ]\n      }\n    },\n    \"Initiator\": \"\",\n    \"AdditionalQueryParameter\": \"(Or,[{\\\"Key\\\",==,[\\\"eVorlagenFavorites\\\"],Or}])\",\n    \"Id\": \"abfb5d10-3ad6-45a3-9f55-3c52d58dff9f\",\n    \"CorrelationId\": \"00-9501e53c1c12b75e777dea15d86359cb-8599a7b91e3d1ad1-00\",\n    \"Type\": \"OperationTicket\",\n    \"Status\": \"Failure\",\n    \"Started\": \"2023-08-22T12:06:18.6140738Z\",\n    \"Finished\": \"2023-08-22T12:06:18.7112435Z\",\n    \"ErrorCode\": 400,\n    \"ErrorMessage\": \"Validation failed.\"\n  }\n</code></pre> <p>In this case, the validation failed because we attempted to add a custom property to a profile with an unknown type.</p>"},{"location":"For%20Developer/API/VolatileData/","title":"Volatile Data","text":"<p>You can store data in a non-standard manner where it won't be persisted in the event store but will only be persisted in the PostgreSQL database. This type of data is referred to as volatile data, such as controller settings used in user settings. This data is stored only for the user. To store such data, you need a user settings section, a user Id and a JSON object. For example, you could store favorite links from YouTube or the user's preferred topics for Udemy videos. </p>"},{"location":"For%20Developer/API/VolatileData/#filtering-the-data","title":"Filtering the Data","text":"<p>If you are looking for specific user settings, you can filter and sort the results accordingly. The results are returned in a paginated format.</p>"},{"location":"For%20Developer/API/VolatileData/#usage-of-the-filter-query","title":"Usage of the $filter query","text":"<p>The $filter query is used to filter of result-set through restrictions. It can be seen as a where-Clause  in the sense of SQL. The filter can only be applied to properties of the result item. Nested properties are not supported yet. Filter expressions can be combined with an <code>OR</code> or an <code>AND</code>. In the example below we have a simple data set that represents a user that has only five properties. The filter can be applied of all of these properties.</p> Sam Smith example filter user <pre><code>{\n    \"Name\": \"Sam, Smith\",\n    \"FirstName\": \"Sam\",\n    \"LastName\": \"Smith\",\n    \"CreatedAt\": \"2022-09-11T09:30:11.6796611+02:00\",\n    \"Id\": 235\n}\n</code></pre> <p>Let's say we want all user that have the same last name. Several users with the same name can be stored in the database. The query would look like:</p> <p><code>LastName eq 'Smith'</code></p> <p>The first item in the query is the property \"LastName\". As second item we have an operator (valid operators see below).The third item is the value with which you want to compare. The value MUST be quoted if it is a type of string or date (in out case all properties except <code>Id</code>). As quotation only single-quotation can be used. Valid quotes are ' and \u2032. Number must not be quoted. Valid operator are:</p> <ul> <li>eq: EqualsOperator</li> <li>ne: NotEqualsOperator</li> <li>gt: GreaterThenOperator</li> <li>ge: GreaterEqualsOperator</li> <li>lt: LessThenOperator </li> <li>le: LessEqualsOperator </li> <li>ct: ContainsOperator</li> </ul> <p>The operators can be applied nearly on every property. But for string only <code>eq</code>, <code>ne</code> and <code>ct</code> make sense. </p> <p>Other Examples</p> <p><code>LastName eq 'Smith' AND FirstName eq 'Sam'</code></p> <p>The user with the last name Smith and first name Sam should be filtered. <code>Id eq 235</code> The user with the Id 235 should be retrieved.</p> <p><code>CreatedAt lt '2023-09-11T09:30:11.6796611+02:00' AND Id ne 235</code></p> <p>Return all user that were created below the data '2023-09-11T09:30:11.6796611+02:00' and Sam, Smith should  not be a part of  the result set.</p> <p>PLEASE NOTICE:  The explanation for the $filter was in general. Every endpoint has his own RESULT. So please look at the Open-Api description which properties are available.</p>"},{"location":"For%20Developer/API/VolatileData/#usage-of-the-oderby-clause","title":"Usage of the $oderBy clause","text":"<p>The $orderBy filter lets your order the result set by one or more properties. The properties must be again in the result set. As our result set we will take again our simple example with the user. To order the user by the first name we can using the query:</p> <p><code>FirstName</code></p> <p>This will order the user by its first name in an ascending order. Please notice that the default-value for the sorting order is ascending. If you want to order the result set in a descending order you can use the query: </p> <p><code>FirstName desc</code></p> <p>If you forget the default sorting value you can still use the abbreviation asc in the query:</p> <p><code>FirstName asc</code></p> <p>It is also possible to sort by two properties. Again we using our simple user model to sort the results by first name in a ascending order and created at in descending order. Notice when using more than two properties you have to separate them with a comma <code>,</code>.</p> <p><code>FirstName, CreatedAt desc</code></p> <p>The $filter query and the $orderby query can be combined.</p>"},{"location":"Installation/Requirements/","title":"Requirements","text":""},{"location":"Installation/Requirements/#third-party-components","title":"Third-party components","text":"<p>To start the service, you need at least the Service and the SagaWorker components, along with the following third-party components:</p> <ul> <li>ArangoDb - open-source graph-and document database where user data will be stored. How to configure Arangodb.</li> <li>Messaging - multi-protocol messaging and streaming broker - used to send messages between applications. How to configure Messaging.</li> <li>PostgreSQL - fast relational database used as volatile store and eventStore. How to configure PostgreSQL.</li> </ul> <p>If you want to use UPS-Sync, you will also need this third-party component:</p> <ul> <li>redis - open source, in-memory data structure store, used as a database, cache, and message broker. How to configure redis.</li> </ul>"},{"location":"Installation/Requirements/#running-the-ups-from-code","title":"Running the UPS from Code","text":"<p>To start using the UserProfileService code, you will need the latest .NET 8.0 SDK, which you can download from here, and the Git source system, available for download here.</p>"},{"location":"Installation/Requirements/#running-the-ups-with-docker-images","title":"Running the UPS with Docker-Images","text":"<p>If you want to use the UPS from Docker images, you'll need to install Docker first. For convenience, you will also need Docker Compose, which can be downloaded here. You can also get the latest images from <code>ghcr.io/bechtleav360</code>.</p>"},{"location":"Installation/Requirements/#configure-the-ups","title":"Configure the UPS","text":"<p>To configure the componenets of the Service refere to:</p> <ul> <li>Service-API</li> <li>SagaWorker</li> <li>Sync</li> </ul>"},{"location":"Installation/Configuration/BasePath/","title":"Base-Path Handling","text":"<p>Additionally, you can opt-in to automatically handle routing base-paths. This is useful to make your service available behind a reverse-proxy or similar setup. To do this, you need to use this method:</p> <ul> <li>Full Path: <code>UserProfileService.Hosting.ApplicationBuilderExtensions.UseReverseProxyPathBases</code></li> <li>As extension: <code>appBuilder.UseReverseProxyPathBases(Configuration)</code></li> </ul> <p>This extension will look for these settings, and configure your application accordingly:</p> Base-Path example configuration <pre><code>{\n    \"Routing\": {\n        \"PathBase\": \"\",\n        \"DiscardResponsePathBase\": \"\"\n    }\n}\n</code></pre> <p>When setting <code>Routing:PathBase</code>, your application will accept requests to all of your usual endpoints (<code>/api/foo</code>), but also those that have the configured Prefix (<code>/service/api/foo</code>). This ensures compatibility with or without reverse-proxy, and pushes consumers of your API to use endpoints with their respective <code>PathBase</code>. You can check <code>HttpContext.Request.PathBase</code> to see if the current request was handled with or without base-path. If <code>Routing:PathBase</code> is set, all redirects will be relative to the configured <code>PathBase</code>, even for those that were handled without it.</p> <ul> <li><code>/api/foo</code> redirecting to the <code>api/bar</code>-endpoint will instead be redirected to <code>/service/api/bar</code></li> <li><code>/service/api/foo</code> redirecting to the <code>api/bar</code>-endpoint will also redirect to <code>/service/api/bar</code></li> </ul> <p>When setting <code>Routing:DiscardResponsePathBase</code> your application will behave as if <code>Routing:PathBase</code> was set, but instead of changing all redirects to use the configured prefix, it will be removed from all redirects.</p> <ul> <li><code>/api/foo</code> redirecting to the <code>api/bar</code>-endpoint will still be redirected to <code>/api/bar</code></li> <li><code>/service/api/foo</code> redirecting to the <code>api/bar</code>-endpoint will instead redirect to <code>/api/bar</code></li> </ul>"},{"location":"Installation/Configuration/BasePath/#technical-notes-to-base-path-handling","title":"Technical notes to Base-Path handling","text":"<p>There are three components to the Base-Path handling, one of which is hidden. - <code>PathBase</code>   - Endpoints will also be bound with this as prefix - <code>ResponsePrefix</code>   - Ensures outgoing responses use this prefix in their path - <code>DiscardResponsePathBase</code>   - Removes this path from the start of all outgoing responses</p> <p>For simplicity's sake we chose to omit <code>RequestPrefix</code> and always use it together with <code>PathBase</code>, which leaves only Options 0 (no settings), 2 (<code>PathBase</code>), and 4 (<code>DiscardResponsePathBase</code>).</p> <p>Using these three settings in different configurations results in these Use-Cases:</p>"},{"location":"Installation/Configuration/BasePath/#option-0-fallback","title":"Option 0 - Fallback","text":"<ul> <li>No option used</li> <li>Endpoints bound using <code>Base=/</code></li> <li>Redirects always use <code>PathBase=/</code></li> </ul> <p>Without any configuration services will use Option-0, they will only be bound and respond to the endpoints defined in the code. To use this configuration each service needs its own hostname or ip to respond to.</p>"},{"location":"Installation/Configuration/BasePath/#option-1-not-supported","title":"Option 1 - Not Supported","text":"<ul> <li><code>PathBase=/service</code></li> <li>Endpoints bound using <code>Base=/</code> and <code>Base=/service</code></li> <li>Redirects keep the Base they originally arrived with</li> </ul> <p>Basically the same as Option-2, but doesn't show or encourage use of endpoints with a defined Base.</p>"},{"location":"Installation/Configuration/BasePath/#option-2-target-default","title":"Option 2 - Target-Default","text":"<ul> <li><code>PathBase=/service</code> + <code>RequestPrefix=/service</code></li> <li>Endpoints bound using <code>Base=/</code> and <code>Base=/service</code></li> <li>Redirects will always use <code>Base=/service</code></li> </ul> <p>Basically the same as Options-1, but pushes consumers to use endpoints with a defined Base. We chose to implicitly use Option-2 and hide Option-1, to hopefully reduce bugs related to path-mapped services.</p>"},{"location":"Installation/Configuration/BasePath/#option-3-not-supported","title":"Option 3 - Not Supported","text":"<ul> <li><code>RequestPrefix=/service</code></li> <li>Endpoints bound using <code>Base=/</code></li> <li>Redirects will always use <code>Base=/service</code></li> </ul> <p>While writing this extension we could find no real use-case for Option-3.</p>"},{"location":"Installation/Configuration/BasePath/#option-4-supported-just-in-case","title":"Option 4 - Supported just in case","text":"<ul> <li><code>DiscardResponsePathBase=/service</code> + (<code>RequestPrefix=\"\"</code> &amp; <code>PathBase=\"\"</code>)</li> <li>Using <code>DiscardResponsePathBase</code> with any other option did not lead to usable results</li> <li>Endpoints bound using <code>Base=/</code> and <code>Base=/service</code></li> <li>Redirects will always use <code>Base=/</code></li> </ul> <p>While we don't expect usage of Option-4, we can see scenarios where this configuration makes sense, so we added it to this extension. Using <code>DiscardResponsePathBase</code> with any other setting did not produce usable results, so we chose to treat its use with other settings as an error.</p>"},{"location":"Installation/Configuration/DatabaseConnection/","title":"Database Connections","text":""},{"location":"Installation/Configuration/DatabaseConnection/#arangodb","title":"ArangoDb","text":"<p>The UserProfileService uses a graph database called ArangoDb.</p> <p>Example configuration section (as part of the complete appsettings file):</p> Arangodb example configuration <pre><code>{\n  \"ProfileStorage\": {\n    \"ClusterConfiguration\": {\n      \"DocumentCollections\": {\n        \"*\": {\n          \"NumberOfShards\": 3,\n          \"ReplicationFactor\": 2,\n          \"WriteConcern\": 1\n        }\n      },\n      \"EdgeCollections\": {\n        \"*\": {\n          \"NumberOfShards\": 3,\n          \"ReplicationFactor\": 2,\n          \"WriteConcern\": 1\n        }\n      }\n    },\n    \"ConnectionString\": \"Endpoints=http://localhost:8529;UserName=myUser;Password=myPassword;database=UserProfileService\",\n    \"MinutesBetweenChecks\": 60\n  }\n}\n</code></pre> <p>The <code>ConnectionString</code> contains the endpoint of the ArangoDb graph database, the credentials and the database to use.</p> <p>Side note: The specified user must have manage permissions for this database. The service will create collections and therefore needs additional rights.</p> <p>The <code>ClusterConfiguration</code> contains information about sharding in a cluster environment when collections are created. It will be ignored on single-node installations.</p> <p><code>MinutesBetweenChecks</code> defines the timespan the database initializer unit will wait until it will ensure all collections has been created. It will do this at the starting of the service as well. This shall minimize the requests sending to ArangoDb during execution of the application.</p>"},{"location":"Installation/Configuration/DatabaseConnection/#postgresql","title":"PostgreSQL","text":"<p>The UserProfileService uses PostgreSQL as a relational database. It can be configured as follows:</p> <p>The <code>ConnectionString</code> defines all parameters to establish a database connection (see NpgSql docs - connection string parameters)</p> <p><code>DatabaseSchema</code> defines the name of the schema to be used.</p> <p>Example:</p> PostgreSQL example configuration <pre><code>{\n  \"Marten\": {\n    \"ConnectionString\": \"Host=localhost;Port=5432;Username=myUser;Password=myPassword;Database=UserProfileService\",\n    \"DatabaseSchema\": \"UserProfile\"\n  }\n}\n</code></pre>"},{"location":"Installation/Configuration/Logging/","title":"Logging","text":"<p>The configuration uses the default .NET Core \"Logging\" configuration of the MEL stack and extends it in an easy way. We are using <code>NLog</code> internally to write logs.</p>"},{"location":"Installation/Configuration/Logging/#configuration-loglevel","title":"Configuration LogLevel","text":"<p>Note: If no configuration is provided the logframework will only log <code>Information</code> or higher (higher meaning greater loglevel value)</p> LogLevel Value Method Description Trace 0 LogTrace Contain the most detailed messages. These messages may contain sensitive app data. These messages are disabled by default and should not be enabled in production. Debug 1 LogDebug For debugging and development. Use with caution in production due to the high volume. Information 2 LogInformation Tracks the general flow of the app. May have long-term value. Warning 3 LogWarning For abnormal or unexpected events. Typically includes errors or conditions that don't cause the app to fail. Error 4 LogError For errors and exceptions that cannot be handled. These messages indicate a failure in the current operation or request, not an app-wide failure. Critical 5 LogCritical For failures that require immediate attention. Examples: data loss scenarios, out of disk space. None 6 Specifies that a logging category should not write any messages. <p>Note: In the <code>LogLevel</code> sub-section you can configure the category specific log level and the global log level. The most specific category configuration is used meaning if <code>SomeCategory</code> is set to Error but <code>SomeCategory.SubSomeCategory</code> is set to trace, than everything in <code>SomeCategory</code> only logs error or higher, but everything staring from <code>SomeCategory.SubSomeCategory</code> will log trace or higher</p> <p>To specify the global loglevel use the <code>Default</code> category name</p> Logging example configuration <pre><code>{\n  \"Logging\": {\n    \"LogLevel\": {\n      \"Default\": \"Trace\",\n      \"&lt;CategoryName&gt;\": \"&lt;LogLevel as string&gt;\"\n    }\n  }\n}\n</code></pre>"},{"location":"Installation/Configuration/Logging/#default-configuration-console-only","title":"Default configuration (console only)","text":"Logging example console configuration <pre><code>{\n  \"Logging\": {\n    \"LogLevel\": {\n      \"Default\": \"Information\"\n    }\n  }\n}\n</code></pre>"},{"location":"Installation/Configuration/Logging/#file-logging","title":"File Logging","text":"<p>To include file logging you need to add the following config-keys inside the \"Logging\" section</p> Logging example file configuration <pre><code>{\n  \"Logging\": {\n    \"EnableLogFile\": true, // (Optional) default: false\n    \"LogFilePath\": \"logs\" // (Optional) default: \"logs\"\n    \"LogFileMaxHistory\": 3 // (Optional) default: 3\n  }\n}\n</code></pre>"},{"location":"Installation/Configuration/Logging/#log-format-text-or-json","title":"Log format (Text or JSON)","text":"<p>To change the log format from JSON (default) to Plaintext change the <code>LogFormat</code> key to the value of <code>text</code> or <code>json</code></p> Logging example log format configuration <pre><code>{\n  \"Logging\": {\n    \"LogFormat\": \"text\"\n  }\n}\n</code></pre>"},{"location":"Installation/Configuration/Redis/","title":"Redis","text":"<p>The UserProfileService-Sync uses Redis as a temporary storage for the synchronized data.</p> <p>An example configuration section could look like this:</p> Redis example configuration <pre><code>{\n  \"Redis\": {\n    \"ServiceName\": \"redis\",\n    \"AbortOnConnectFail\": \"False\",\n    \"AllowAdmin\": \"True\",\n    \"ConnectRetry\": 5,\n    \"ConnectTimeout\": 5000,\n    \"EndpointUrls\": [\n      \"localhost:6379\"\n    ],\n    \"ExpirationTime\": 7200,\n    \"Password\": \"\",\n    \"User\": \"\"\n  }\n}\n</code></pre> <p>The <code>EndpointUrls</code> define the endpoints for Redis. Please note that <code>EndpointUrls</code> is an array where you can store more than one Redis endpoint. In this section, Redis is only bound to localhost. The port 6379 is the standard port for Redis.</p> <p>The <code>User</code> and <code>Password</code> are used for authentication to the Redis system.</p> <p>The other configuration options for redis:</p> <p><code>ServiceName</code> -  The service name used to resolve a service via the Sentinel.</p> <p><code>AbortOnConnectFail</code> - A connection will not be established while no servers are available.</p> <p><code>AllowAdmin</code> - Enables a range of commands that are considered risky.</p> <p><code>ConnectRetry</code> - The number of times to repeat connect attempts during initial Connect.</p> <p><code>ConnectTimeout</code> - Timeout (ms) for connect operations.</p> <p><code>ExpirationTime</code> - Expiration time after the stored values in redis expires and are deleted (in seconds).</p>"},{"location":"Installation/Configuration/Tracing/","title":"Tracing","text":"<p>Basic configuration requires you to set at least a <code>ServiceName</code>. The service name will be displayed in the trace graph and used to correlate the logs. If you also provide an <code>OtlpEndpoint</code> URI the OtlpExporter will be setup to send traces via GRPC in the OTLP format to the provided endpoint.</p> <p>An example of the trace configuration can resemble this:</p> Tracing exmaple configuration <pre><code>{\n    \"Tracing\": {\n        \"OtlpEndpoint\": \"http://localhost:4317\",\n        \"ServiceName\": \"userprofile-service\"\n    }\n}\n</code></pre>"},{"location":"Installation/Configuration/Messaging/","title":"Message Configuration","text":"<p>The UPS can be configured to use two different queue communication systems for communication between its workers. You can use:</p> <ul> <li>RabbitMq</li> <li>ServiceBus</li> </ul> <p>The important key is <code>Type</code>. This key configures the communication system. The JSON to configure the messaging looks similar to these examples:</p> Messaging configuration <pre><code>{\n  \"Messaging\": {\n    \"MessageType\": {\n        ...\n    },\n    \"Type\": \"MessageType\"\n  }\n}\n</code></pre> <p>For the <code>Type</code> key, you can use the value <code>RabbitMq</code> or <code>ServiceBus</code>. The keywords are case-insensitive, so it doesn't matter how you write them.</p>"},{"location":"Installation/Configuration/Messaging/AzureServiceBus/","title":"Azure Service Bus","text":"<p>If you want to use AzureServicBus for communication, you need to set <code>ServiceBus</code> as the value for the <code>Type</code> key. This will ensure that internal messaging uses Azure Service Bus.</p> <p>An example configuration section could look like this:</p> Azure Service Bus example configuration <pre><code>{\n  \"Messaging\": {\n    \"ServiceBus\": {\n      \"ConnectionString\": \"Endpoint=sb://&lt;NamespaceName&gt;.servicebus.windows.net/;\n      SharedAccessKeyName=&lt;KeyName&gt;;SharedAccessKey=&lt;KeyValue&gt;\",\n    },\n    \"Type\": \"ServiceBus\"\n  }\n}\n</code></pre> <p><code>Endpoint</code> - The URL of your Service Bus namespace. This always starts with sb://, followed by your Service Bus namespace name, and ends with .servicebus.windows.net/.</p> <p><code>SharedAccessKeyName</code> - The name of the shared access policy you are using. This is usually a policy that grants access to the Service Bus namespace or a specific queue/topic.</p> <p><code>SharedAccessKey</code> - The key associated with the shared access policy. This is a secret value that acts like a password for the connection.</p>"},{"location":"Installation/Configuration/Messaging/RabbitMq/","title":"RabbitMQ","text":"<p>If you want to use RabbitMq for communication, you need to set <code>RabbitMQ</code> as the value for the <code>Type</code> key. This will ensure that internal messaging uses RabbitMQ.</p> <p>An example configuration section could look like this:</p> RabbitMQ example configuration <pre><code>{\n  \"Messaging\": {\n    \"RabbitMQ\": {\n      \"Host\": \"localhost\",\n      \"Password\": \"myPassword\",\n      \"Port\": 5672,\n      \"User\": \"myUser\",\n      \"VirtualHost\": \"/\"\n    },\n    \"Type\": \"RabbitMQ\"\n  }\n}\n</code></pre> <p><code>Host</code> - The RabbitMQ server's hostname or IP address.</p> <p><code>Port</code> - The port number on which RabbitMQ is listening.</p> <p><code>VirtualHost</code> - The virtual host in RabbitMQ to which you want to connect.</p> <p><code>User</code> - The username used to authenticate with RabbitMQ.</p> <p><code>Password</code> - The password associated with the RabbitMQ user.</p>"},{"location":"Installation/Configuration/SagaWorker/","title":"SagaWorker Configuration","text":"<p>A valid saga worker configuration can look like this. Please note that you should create a database in ArangoDB and PostgreSQL and grant permissions for the user. This is not done automatically:</p> SagaWorker example configuration <pre><code>{\n\"Cleanup\": {\n    \"AssignmentProjection\": null,\n    \"EventCollector\": null,\n    \"Facade\": null,\n    \"FirstLevelProjection\": null,\n    \"Interval\": \"5:00:00:00\",\n    \"Service\": null\n  },\n\n  \"Logging\": {\n    \"EnableLogFile\": false,\n    \"LogFileMaxHistory\": 3,\n    \"LogFilePath\": \"logs\",\n    \"LogFormat\": \"json\",\n    \"LogLevel\": {\n      \"default\": \"Information\"\n    }\n  },\n\n  \"Marten\": {\n    \"ConnectionString\": \"Host=localhost;Port=5432;Username=myUser;Password=myPassword;Database=UserProfileService\",\n    \"DatabaseSchema\": \"UserProfile\",\n    \"StreamNamePrefix\": \"ups\",\n    \"SubscriptionName\": \"UserProfileServiceStream\"\n  },\n\n  \"Messaging\": {\n    \"RabbitMQ\": {\n      \"Host\": \"localhost\",\n      \"Password\": \"guest\",\n      \"Port\": 5672,\n      \"User\": \"guest\",\n      \"VirtualHost\": \"/\"\n    },\n    \"Type\": \"RabbitMQ\"\n  },\n\n  \"ProfileStorage\": {\n    \"ClusterConfiguration\": {\n      \"DocumentCollections\": {\n        \"*\": {\n          \"NumberOfShards\": 3,\n          \"ReplicationFactor\": 2,\n          \"WriteConcern\": 1\n        }\n      },\n      \"EdgeCollections\": {\n        \"*\": {\n          \"NumberOfShards\": 3,\n          \"ReplicationFactor\": 2,\n          \"WriteConcern\": 1\n        }\n      }\n    },\n    \"ConnectionString\": \"Endpoints=http://localhost:8529;UserName=myUser;Password=myPassword;database=UserProfileService\",\n    \"MinutesBetweenChecks\": 60\n  },\n\n  \"Routing\": {\n    \"DiscardResponsePathBase\": \"\",\n    \"PathBase\": \"\"\n  },\n\n  \"Seeding\": {\n    \"Disabled\": true\n  },\n\n  \"Tracing\": {\n    \"OtlpEndpoint\": \"\",\n    \"ServiceName\": \"userprofile-saga-worker\"\n  },\n\n\n  \"Validation\": {\n    \"Commands\": {\n      \"External\": {\n        \"profile-deleted\": false\n      }\n    },\n\n    \"Internal\": {\n      \"Function\": {\n        \"DuplicateAllowed\": false\n      },\n\n      \"Group\": {\n        \"Name\": {\n          \"Duplicate\": false,\n          \"IgnoreCase\": true,\n          \"Regex\": \"^[a-zA-Z0-9\u00c4\u00d6\u00dc\u00e4\u00f6\u00fc\u00df_\\\\]\\\\[\\\\-\\\\.\\\\\\\\ @]+$\"\n        }\n      },\n\n      \"User\": {\n        \"DuplicateEmailAllowed\": false\n      }\n    }\n  }\n}\n</code></pre> <p>The saga woker is configured to allow access to all necessary third-party components through the localhost endpoints.</p>"},{"location":"Installation/Configuration/SagaWorker/Cleanup/","title":"Configure Cleanup Service","text":"<p>The Cleanup configuration section outlines the frequency at which data cleanup operations are performed for various components. Here is a brief example of how to configure the cleanup:</p> Cleaup service example configuration <pre><code>{\n  \"Cleanup\": {\n    \"AssignmentProjection\": \"05:00:00\",\n    \"EventCollector\": \"05:00:00\",\n    \"Facade\": \"05:00:00\",\n    \"FirstLevelProjection\": \"05:00:00\",\n    \"Service\": \"05:00:00\"\n  }\n}\n</code></pre> <p><code>AssignmentProjection</code>- Specifies the interval at which cleanup operations are performed for the Assignment Projection component.</p> <p><code>EventCollector</code> - Specifies the interval at which cleanup operations are performed for the Event Collector component.  </p> <p><code>Facade</code> - Specifies the interval at which cleanup operations are performed for the Facade component. </p> <p><code>FirstLevelProjection</code> - Specifies the interval at which cleanup operations are performed for the First Level Projection component. </p> <p><code>Service</code> - Specifies the interval at which cleanup operations are performed for the Service component.</p> <p>Note: The value is represented in hours, minutes, and seconds format (HH:MM:SS). In our sample all components will be cleaned every 5 hours.</p>"},{"location":"Installation/Configuration/SagaWorker/Seeding/","title":"Configure Seeding Service","text":"<p>The seeding service is responsible for seeding configurations at startup. It can seed the following entities:</p> <ul> <li>Functions</li> <li>Groups</li> <li>Organizations</li> <li>Roles</li> <li>Users </li> </ul> <p>A brief section on configuring the seeding service with various entities:</p> Seeding example configuration <pre><code>{\n  \"SeedingService\": {\n    \"Users\": {\n      \"f2e51ef1-57bc-4c11-931f-079b4303d657\": {\n        \"DisplayName\": \"John Doe\",\n        \"Email\": \"johndoe@example.com\",\n        \"ExternalIds\": [\n          {\n            \"Id\": \"f2e51ef1-57bc-4c11-931f-079b4303d657\",\n            \"Source\": \"SeedingService\",\n            \"IsConverted\": false\n          }\n        ],\n        \"FirstName\": \"John\",\n        \"LastName\": \"Doe\",\n        \"Name\": \"John Doe\",\n        \"UserName\": \"johnd\"\n      }\n    },\n    \"Roles\": {\n      \"fa6ee24b-0fc4-4632-9c0d-5b943d8a8ac8\": {\n        \"ExternalIds\": [\n          {\n            \"Id\": \"fa6ee24b-0fc4-4632-9c0d-5b943d8a8ac8\",\n            \"Source\": \"SeedingService\",\n            \"IsConverted\": false\n          }\n        ],\n        \"DeniedPermissions\": [\n          \"Delete\",\n          \"Edit\"\n        ],\n        \"Description\": \"This role provides limited access to certain features.\",\n        \"IsSystem\": false,\n        \"Name\": \"LimitedAccessRole\",\n        \"Permissions\": [\n          \"Read\",\n          \"Write\"\n        ]\n      }\n    },\n    \"Groups\": {\n      \"a6ee24b0fc446329c0d5b943d8a8ac8\": {\n        \"DisplayName\": \"Marketing Team\",\n        \"ExternalIds\": [\n          {\n            \"Id\": \"fa6ee24b-0fc4-4632-9c0d-5b943d8a8ac8\",\n            \"Source\": \"SeedingService\",\n            \"IsConverted\": false\n          }\n        ],\n        \"Name\": \"Marketing\",\n        \"Weight\": 2.0\n      }\n    },\n    \"Organizations\": {\n      \"8a5fd2b1-6e17-4c35-9314-7d13f67f3278\": {\n        \"DisplayName\": \"Acme Corporation\",\n        \"ExternalIds\": [\n          {\n            \"Id\": \"8a5fd2b1-6e17-4c35-9314-7d13f67f3278\",\n            \"Source\": \"SeedingService\",\n            \"IsConverted\": false\n          }\n        ],\n        \"IsSystem\": false,\n        \"Name\": \"Acme\",\n        \"Weight\": 2.0\n      }\n    },\n    \"Functions\": {\n      \"d6d78a90-e5c2-47fb-ba82-71f3cb5f4dc2\": {\n        \"ExternalIds\": [\n          {\n            \"Id\": \"d6d78a90-e5c2-47fb-ba82-71f3cb5f4dc2\",\n            \"Source\": \"SeedingService\",\n            \"IsConverted\": false\n          }\n        ],\n        \"Name\": \"John Doe\",\n        \"OrganizationId\": \"8a5fd2b1-6e17-4c35-9314-7d13f67f3278\",\n        \"RoleId\": \"fa6ee24b-0fc4-4632-9c0d-5b943d8a8ac8\"\n      }\n    }\n  },\n  \"Disabled\": false\n}\n</code></pre> <p><code>Users</code> - This describes the users that need to be created. It is represented as a dictionary. Each user is identified by a unique ID which serves as the key, followed by the user's properties that need to be filled out.</p> <p><code>Roles</code> - This describes the roles that need to be created. It is represented as a dictionary. Each role is identified by a unique ID which serves as the key, followed by the roles's properties that need to be filled out.</p> <p><code>Groups</code> - This describes the groups that need to be created. It is represented as a dictionary. Each group is identified by a unique ID which serves as the key, followed by the group's properties that need to be filled out.</p> <p><code>Organizations</code> - This describes the organizations that need to be created. It is represented as a dictionary. Each organization is identified by a unique ID which serves as the key, followed by the organizations's properties that need to be filled out.</p> <p><code>Functions</code> - This describes the functions that need to be created. It is represented as a dictionary. Each functions is identified by a unique ID which serves as the key, followed by the functions's properties that need to be filled out. </p> <p>Please Note: The function consists of an organization and a role ID. The role and organization ID must be present; otherwise, the function won't be created. \"Present\" means that the role and organization object must already exist or be defined in the seeding service. If it's not present, the function won't be created.</p> <p><code>Disabled</code> - Indicates whether the seeding service should be disabled. If the seeding service is disabled, none of the creation objects should be configured. The configuration can than look like this:</p> Seeding disable example configuration <pre><code>{\n  \"Seeding\": {\n    \"Disabled\": true\n  }\n}\n</code></pre>"},{"location":"Installation/Configuration/SagaWorker/Seeding/#notes","title":"Notes","text":"<p>The seeding service checks every time the saga worker is started whether the seeding objects already exist. If they do not exist, they will be created; otherwise, they will not be created. This is relevant when the seeding service has objects to seed.</p>"},{"location":"Installation/Configuration/SagaWorker/Validation/","title":"Configure SagWorker Validation","text":"<p>Here is a brief section on how the validation can be configured:</p> SagaWorker example validation configuration <pre><code>{\n  \"Validation\": {\n    \"Commands\": {\n      \"External\": {\n        \"profile-deleted\": false\n      }\n    },\n    \"Internal\": {\n      \"Function\": {\n        \"DuplicateAllowed\": false\n      },\n      \"Group\": {\n        \"Name\": {\n          \"Duplicate\": false,\n          \"IgnoreCase\": true,\n          \"Regex\": \"^[a-zA-Z0-9\u00c4\u00d6\u00dc\u00e4\u00f6\u00fc\u00df_\\\\]\\\\[\\\\-\\\\.\\\\\\\\ @]+$\"\n        }\n      },\n      \"User\": {\n        \"DuplicateEmailAllowed\": false\n      }\n    }\n  }\n}\n</code></pre> <p><code>profile-deleted</code> - Specifies whether the profile-deleted messages will be validated by an external system or not.</p> <p><code>DuplicateAllowed</code> - Specifies if duplicate functions are permissible.</p> <p><code>Duplicate</code> - Determines whether a duplicate check is performed for the (display) name.</p> <p><code>IgnoreCase</code> - Specifies if the duplicate check should be case-insensitive. This is applicable only if <code>DuplicateAllowed</code> is set to false.</p> <p><code>Regex</code> - Defines the regular expression used to validate the name and displayName.</p> <p><code>DuplicateEmailAllowed</code> - Indicates whether a duplicate check is performed for email addresses.</p>"},{"location":"Installation/Configuration/Service/","title":"Service Configuration","text":"<p>A valid service configuration can look like this. Please note that you should create a database in ArangoDB and PostgreSQL and grant permissions for the user. This is not done automatically:</p> Service example configuration <pre><code>{\n  \"Delays\": {\n    \"HealthCheck\": \"1:00:00\",\n    \"HealthPush\": \"1:00:00\"\n  },\n\n  \"Features\": {\n    \"UseSwaggerUI\": true\n  },\n\n\"IdentitySettings\": {\n    \"ApiName\": \"\",\n    \"ApiSecret\": \"\",\n    \"Authority\": \"\",\n    \"EnableAnonymousImpersonation\": false,\n    \"EnableAuthorization\": false,\n    \"EnableCaching\": false,\n    \"RequireHttpsMetadata\": false\n  },\n\n  \"Logging\": {\n    \"EnableLogFile\": false,\n    \"LogFileMaxHistory\": 3,\n    \"LogFilePath\": \"logs\",\n    \"LogFormat\": \"json\",\n    \"LogLevel\": {\n      \"default\": \"Information\"\n    }\n  },\n\n  \"Marten\": {\n    \"ConnectionString\": \"Host=localhost;Port=5432;Username=myUser;Password=myPassword;Database=UserProfileService\",\n    \"DatabaseSchema\": \"UserProfile\",\n    \"StreamNamePrefix\": \"ups\",\n    \"SubscriptionName\": \"UserProfileServiceStream\"\n  },\n\n  \"Messaging\": {\n    \"RabbitMQ\": {\n      \"Host\": \"localhost\",\n      \"Password\": \"guest\",\n      \"Port\": 5672,\n      \"User\": \"guest\",\n      \"VirtualHost\": \"/\"\n    },\n    \"Type\": \"RabbitMQ\"\n  },\n\n  \"ProfileStorage\": {\n    \"ConnectionString\": \"Endpoints=http://localhost:8529;UserName=myUser;Password=myPassword;database=UserProfileService\",\n    \"MinutesBetweenChecks\": 60\n  },\n\n  \"Routing\": {\n    \"DiscardResponsePathBase\": \"\",\n    \"PathBase\": \"\"\n  },\n\n  \"SyncProxyConfiguration\": {\n    \"Endpoint\": \"\"\n  },\n\n  \"TicketStore\": {\n    \"Backend\": \"arangodb\"\n  },\n\n  \"Tracing\": {\n    \"OtlpEndpoint\": \"\",\n    \"ServiceName\": \"userprofile-service\"\n  },\n\n  \"UseForwardedHeaders\": false\n}\n</code></pre> <p>The service is configured to allow access to all necessary third-party components through the localhost endpoints.</p>"},{"location":"Installation/Configuration/Service/Headers/","title":"Configure Headers","text":"<p>Here is a sample section on how to configure the headers:</p> Headers example configuration <pre><code>{\n  \"UseForwardedHeaders\": false\n}\n</code></pre> <p><code>UseForwardedHeaders</code> - Specifies whether the application should use forwarded headers or not. When set to false, the application will not use forwarded headers.</p>"},{"location":"Installation/Configuration/Service/HealthChecks/","title":"Configure Health-Checks","text":"<p>Here is a sample section on how to configure the health checks:</p> Health-Checks example configuration <pre><code>{\n  \"Delays\": {\n    \"HealthCheck\": \"00:05:00\",\n    \"HealthPush\": \"00:05:00\"\n  }\n}\n</code></pre> <p><code>HealthCheck</code>- Specifies the interval at which health checks are performed. The value is represented in hours, minutes, and seconds format (HH:MM:SS). For example, 00:05:00 indicates a health check interval of 5 minutes.</p> <p><code>HealthPush</code>- Specifies the interval at which health push operations are performed. The value is represented in hours, minutes, and seconds format (HH:MM:SS). For example, 00:05:00 indicates a health push interval of 5 minutes.</p>"},{"location":"Installation/Configuration/Service/Identity/","title":"Configure Identity","text":"<p>Here is a sample section on how to configure the identity settings:</p> Identity example configuration <pre><code>{\n  \"IdentitySettings\": {\n    \"ApiName\": \"MyApi\",\n    \"ApiSecret\": \"SuperSecretKey\",\n    \"Authority\": \"https://identity.example.com\",\n    \"EnableAnonymousImpersonation\": false,\n    \"EnableAuthorization\": true,\n    \"EnableCaching\": true,\n    \"RequireHttpsMetadata\": true\n  }\n}\n</code></pre> <p><code>ApiName</code> - The name of the API, typically used to identify the API within your identity provider.</p> <p><code>ApiSecret</code> - The secret key associated with the API. This key is used for authentication and should be kept confidential.</p> <p><code>Authority</code> - The URL of the identity provider. This endpoint handles authentication and authorization.</p> <p><code>EnableAnonymousImpersonation</code> - Determines whether anonymous impersonation is enabled. When enabled, users can impersonate anonymous identities.</p> <p><code>EnableAuthorization</code>- Specifies whether authorization is enabled. If this option is disabled, the API will not enforce authorization rules.</p> <p><code>EnableCaching</code> - Indicates whether caching is enabled. When enabled, identity-related data is cached to improve performance.</p> <p><code>RequireHttpsMetadata</code>- Specifies whether HTTPS is required for retrieving metadata from the identity provider. If this option is disabled, HTTP is also allowed.</p>"},{"location":"Installation/Configuration/Service/Identity/#notes","title":"Notes","text":"<ul> <li>Only the <code>user/me</code> endpoint is secured in the service</li> <li>Ensure that the ApiSecret is stored securely and not exposed in public repositories.</li> <li>It is recommended to set RequireHttpsMetadata to true in production environments to ensure secure communication with the identity provider.</li> <li>The Authority URL must be correctly configured to point to your identity provider to ensure proper authentication and authorization.</li> </ul>"},{"location":"Installation/Configuration/Service/SwaggerUI/","title":"Configure SwaggerUI","text":"<p>Here is a sample section on how to configure the SwaggerUI:</p> SwaggerUI example configuration <pre><code>{\n  \"Features\": {\n    \"UseSwaggerUI\": true\n  }\n}\n</code></pre> <p><code>UseSwaggerUI</code> - The UseSwaggerUI setting controls the visibility of the Swagger UI. When enabled, users can access and interact with the API documentation through the Swagger UI. Conversely, when disabled, the Swagger UI is not accessible.</p> <p>Development Mode Only: It's important to note that the Swagger UI functionality is only available in development mode. This means that it will be active during development and testing phases but is disabled or inaccessible in production environments.</p>"},{"location":"Installation/Configuration/Service/SyncProxy/","title":"Configure SyncProxy","text":"<p>Here is a sample section on how to configure the sync proxy:</p> SyncProxy example configuration <pre><code>{\n  \"SyncProxyConfiguration\": {\n    \"Endpoint\": \"http://example.com/sync-api\"\n  }\n}\n</code></pre> <p><code>Endpoint</code> - Specifies the endpoint of the service that will control the Sync API. This endpoint should be set to the URL of the sync that manages the API requests. This allows for centralized control and management of the Sync API via the designated service.</p>"},{"location":"Installation/Configuration/Service/TicketStore/","title":"Configure Ticketstore","text":"<p>Here is a sample section on how to configure the ticket store:</p> Ticketstore example configuration <pre><code>{\n  \"TicketStore\": {\n    \"Backend\": \"arangodb\"\n  }\n}\n</code></pre> <p><code>Backend</code> - The Backend setting should be configured to match the database you are using for storing tickets. The possible values are <code>arangodb</code>, <code>sqlServer</code>, <code>postgres</code>, and <code>sqLite</code></p>"},{"location":"Installation/Configuration/Sync/","title":"Sync Configuration","text":"<p>A valid sync configuration can look like this. Please note that you should create a database in ArangoDB and PostgreSQL and grant permissions for the user. This is not done automatically. The LDAP configuration currently in use is invalid; it's purely an EXAMPLE. Here's a guide on how to properly configure the LDAP Connector for synchronization.</p> Sync example configuration <pre><code>{\n  \"Logging\": {\n    \"EnableLogFile\": false,\n    \"LogFileMaxHistory\": 3,\n    \"LogFilePath\": \"logs\",\n    \"LogFormat\": \"json\",\n    \"LogLevel\": {\n      \"default\": \"Information\"\n    }\n  },\n  \"Marten\": {\n    \"ConnectionString\": \"Host=localhost;Port=5432;Username=myUser;Password=myPassword;Database=UserProfileService\",\n    \"DatabaseSchema\": \"UserProfile\",\n    \"StreamNamePrefix\": \"ups\",\n    \"SubscriptionName\": \"UserProfileServiceStream\"\n  },\n  \"Messaging\": {\n    \"RabbitMQ\": {\n      \"Host\": \"localhost\",\n      \"Password\": \"1\",\n      \"Port\": 5672,\n      \"User\": \"sb\",\n      \"VirtualHost\": \"/\"\n    },\n    \"Type\": \"RabbitMQ\"\n  },\n  \"ProfileStorage\": {\n    \"ClusterConfiguration\": {\n      \"DocumentCollections\": {\n        \"*\": {\n          \"NumberOfShards\": 3,\n          \"ReplicationFactor\": 2,\n          \"WriteConcern\": 1\n        }\n      },\n      \"EdgeCollections\": {\n        \"*\": {\n          \"NumberOfShards\": 3,\n          \"ReplicationFactor\": 2,\n          \"WriteConcern\": 1\n        }\n      }\n    },\n    \"ConnectionString\": \"Endpoints=http://localhost:8529;UserName=myUser;Password=myPassword;database=UserProfileService\",\n    \"MinutesBetweenChecks\": 60\n  },\n  \"Redis\": {\n    \"AbortOnConnectFail\": false,\n    \"AllowAdmin\": true,\n    \"ConnectRetry\": 5,\n    \"ConnectTimeout\": 5000,\n    \"EndpointUrls\": [\n      \"localhost:6379\"\n    ],\n    \"ExpirationTime\": 7200,\n    \"Password\": null,\n    \"User\": null\n  },\n  \"Routing\": {\n    \"DiscardResponsePathBase\": \"\",\n    \"PathBase\": \"\"\n  },\n  \"SyncConfiguration\": {\n    \"SourceConfiguration\": {\n      \"Systems\": {\n        \"Ldap\": {\n          \"EntitiesMapping\": {\n            \"DisplayName\": \"displayname\",\n            \"Email\": \"mail\",\n            \"FirstName\": \"givenName\",\n            \"LastName\": \"sn\",\n            \"Name\": \"Name\",\n            \"UserName\": \"cn\"\n          },\n          \"LdapConfiguration\": [\n            {\n              \"Connection\": {\n                \"AuthenticationType\": \"None\",\n                \"BasePath\": \"dc=ad, dc=example, dc=com\",\n                \"ConnectionString\": \"LDAP://ad.exmpale.com\",\n                \"Description\": \"Default AD of A365 development environment\",\n                \"IgnoreCertificate\": false,\n                \"Port\": 389,\n                \"ServiceUser\": \"CN=dev,OU=ExampleOU,OU=ExampleOU2,OU=DEVOU,DC=ad,DC=example,DC=com\",\n                \"ServiceUserPassword\": \"Password\",\n                \"UseSsl\": false\n              },\n              \"LdapQueries\": [\n                {\n                  \"Filter\": \"(&amp;(|(objectClass=user)(objectClass=inetOrgPerson))(!(objectClass=computer))(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))\",\n                  \"SearchBase\": \"OU=Users,OU=Accounts,OU=Management\"\n                }\n              ]\n            }\n          ],\n          \"Source\": {\n            \"users\": {\n              \"ForceDelete\": \"False\",\n              \"Operations\": \"Add,Update,Delete\"\n            }\n          },\n          \"Validation\": {\n            \"Commands\": {\n              \"External\": {\n                \"profile-deleted\": false\n              }\n            },\n            \"Internal\": {\n              \"User\": {\n                \"DuplicateEmailAllowed\": false\n              }\n            }\n          }\n        }\n      }\n    },\n    \"Tracing\": {\n      \"OtlpEndpoint\": \"\",\n      \"ServiceName\": \"userprofile-sync\"\n    }\n  }\n}\n</code></pre> <p>The service is configured to allow access to all necessary third-party components through the localhost endpoints.</p>"},{"location":"Installation/Configuration/Sync/LdapConfiguration/","title":"Configure LDAP Connector","text":"<p>As of now, we offer support for an LDAP Connector capable of synchronizing data from an existing Active Direcotry for example. The configuration for this feature can be found under the <code>LDAP</code> section. We will explain all sections step by step. Below is an example configuration for the Active Directory System.</p> LDAP example configuration <pre><code>{\n  \"Ldap\": {\n    \"EntitiesMapping\": {\n      \"DisplayName\": \"displayname\",\n      \"Email\": \"mail\",\n      \"FirstName\": \"givenName\",\n      \"LastName\": \"sn\",\n      \"Name\": \"Name\",\n      \"UserName\": \"cn\"\n    },\n    \"LdapConfiguration\": [\n      {\n        \"Connection\": {\n          \"AuthenticationType\": \"None\",\n          \"BasePath\": \"dc=ad, dc=example, dc=com\",\n          \"ConnectionString\": \"LDAP://ad.exmpale.com\",\n          \"Description\": \"Default AD of A365 development environment\",\n          \"IgnoreCertificate\": false,\n          \"Port\": 389,\n          \"ServiceUser\": \"CN=dev,OU=ExampleOU,OU=ExampleOU2,OU=DEVOU,DC=ad,DC=example,DC=com\",\n          \"ServiceUserPassword\": \"Password\",\n          \"UseSsl\": false\n        },\n        \"LdapQueries\": [\n          {\n            \"Filter\": \"(&amp;(|(objectClass=user)(objectClass=inetOrgPerson))(!(objectClass=computer))(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))\",\n            \"SearchBase\": \"OU=Users,OU=Accounts,OU=Management\"\n          }\n        ]\n      }\n    ],\n    \"Source\": {\n      \"users\": {\n        \"ForceDelete\": \"False\",\n        \"Operations\": \"Add,Update,Delete\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"Installation/Configuration/Sync/LdapConfiguration/#entitiesmapping-section","title":"EntitiesMapping Section","text":"<p>The entity mapping is utilized to map LDAP attributes to the user. On the left side, properties of the user model are specified. On the right side, LDAP attributes are utilized. Therefore, the DisplayName property will contain values stored under the attribute displayName in the LDAP Sytem. It's important to note that the properties of the user model must be written exactly as in the class. Refer to the UserModel for more details.</p>"},{"location":"Installation/Configuration/Sync/LdapConfiguration/#ldapconfiguration-section","title":"LdapConfiguration Section","text":"<p>Under the LdapConfiguration, you can specify the LDAP system from which you want to synchronize the data. The Connection specifies the credentials for accessing the LDAP system. The LdapQueries precisely define which users should be synchronized to the user profile system. You can specify multiple LDAP systems from which you want to synchronize.</p>"},{"location":"Installation/Configuration/Sync/LdapConfiguration/#connection-section","title":"Connection Section","text":"<p>The Connection object encapsulates all the necessary properties required to establish a connection with an existing LDAP system. We utilize the Novell.Directory.Ldap.NETStandard library for this purpose. For further details regarding the connection, please refer to the documentation provided here.</p> <p><code>AuthenticationType</code> - Is used to specify the type of authentication to be used when logging into an existing LDAP system. \"None\" is using no authentification. Only a username and a password are required.</p> <p><code>BasePath</code> - The base bath to the LDPA System.</p> <p><code>ConnectionString</code> - The connection to the LDAP System.</p> <p><code>Description</code> - The description of the used system. This property is optional.</p> <p><code>IgnoreCertificate</code> - If a certificate is to be ignored during synchronization with the LDAP System. The default value is <code>false</code>.</p> <p><code>Port</code> - The port that is used to create a connection to the LDAP-System. The port used to establish the connection is typically 389, which is the standard port for LDAP. The secured standard port is 636, and it should be used when <code>UseSsL</code> is set to true. Please note that these ports are standard settings. When configuring your LDAP system, you may also use other ports.</p> <p><code>ServiceUser</code> - The Service user that is used to connect to the LDAP System.</p> <p><code>ServiceUserPassword</code> - The password of the <code>ServiceUser</code> for logging into the LDAP system.</p> <p><code>UseSsl</code> - Indicates whether a secure connection to the LDAP system is being used. If this property is enabled, the port must be set to the secure port. The standard secure port is 636, but it can vary based on your LDAP system configuration.</p>"},{"location":"Installation/Configuration/Sync/LdapConfiguration/#ldapqueries-section","title":"LdapQueries Section","text":"<p>LDAP queries are search requests sent to an LDAP directory to retrieve specific information. They allow for searching and retrieving data about users, groups, organizational units, and other directory objects. LDAP queries can include various parameters such as filters defining specific search criteria and attributes specifying which information to return.</p> <p><code>Filter</code> - LDAP filters are expressions used in LDAP queries to specify specific search criteria. They allow for filtering search results to return only objects that meet certain properties.</p> <p><code>SearchBase</code> - The \"SearchBase\" in LDAP systems refers to the base distinguished name (DN) from which LDAP searches are initiated. It serves as the starting point for search operations in the directory tree. The server begins the search from this base DN and traverses the directory tree to locate objects matching the search criteria.</p> <p>You can specify as many queries as needed, ensuring they match the configuration of your LDAP system.</p> <p>For more information, it's recommended to explore LDAP and familiarize yourself with the various filters that can be utilized.</p>"},{"location":"Installation/Configuration/Sync/LdapConfiguration/#source-section","title":"Source Section","text":"<p>This section solely describes the entities that can be synchronized from the LDAP system and whether the entities can be modified in the UserProfileService. For the LDAP Connector, only user entities can be synchronized from an LDAP system. Here is a brief configuration of the source section:</p> LDAP source example configuration <pre><code>{\n  \"Source\": {\n    \"users\": {\n      \"ForceDelete\": \"False\",\n      \"Operations\": \"Add,Update,Delete\"\n    }\n  }\n}\n</code></pre> <p><code>Operations</code> - Defines the operations that can be performed on users. Possible configurations include <code>added</code>, <code>updated</code>, or <code>deleted</code>.</p> <p><code>ForceDelete</code> - Indicates whether users should be forcefully deleted if they are not present in the LDAP system.</p>"},{"location":"Installation/Configuration/Sync/LdapConfiguration/#recommendation","title":"Recommendation","text":"<p>This was just a brief introduction to configuring the synchronization system using LDAP. We assume familiarity with this protocol. If not, we recommend further reading to gain understanding.</p>"},{"location":"Installation/Configuration/Sync/Validation/","title":"Configure Sync Validation","text":"<p>Here is a brief section on how the validation can be configured</p> Sync validation example configuration <pre><code>{\n  \"Validation\": {\n    \"Commands\": {\n      \"External\": {\n        \"profile-deleted\": false\n      }\n    },\n    \"Internal\": {\n      \"User\": {\n        \"DuplicateEmailAllowed\": false\n      }\n    }\n  }\n}\n</code></pre> <p><code>profile-deleted</code> - Specifies whether the profile-deleted messages will be validated by an external system or not.</p> <p><code>DuplicateEmailAllowed</code> - Indicates whether a duplicate check is performed for email addresses.</p>"},{"location":"Installation/Get%20Started/Docker/","title":"Docker Files","text":"<p>We have prepared a set of docker compose files, allowing you to effortlessly set up and explore UserProfileService in isolated containers. The files include all third-party dependencies and are pre-configured to run seamlessly within the container environment.</p> <p>Please be aware that the examples provided should not be used in a production environment! They are intended to give you an impression of how the UserProfileService works and should only be utilized in a development environment for testing purposes.</p> <p>The examples can be found here.</p>"},{"location":"Installation/Get%20Started/Single%20Instance/","title":"Single Instance","text":"<p>If you want to start the user profile service from the codebase and you have met all the requirements, you can launch it from the console. First, clone the code from GitHub:</p> <p><code>git clone https://github.com/bechtleav360/Maverick.UserProfileService.git</code></p> <p>Then you can start each components with the command: <code>dotnet run</code></p> <p>You need to navigate to the correct folder:</p> <ul> <li>For starting UserProfile-API: <code>../Maverick.UserProfileService/src/UserProfileService</code></li> <li>For startingstarting Saga-Worker: <code>../Maverick.UserProfileServicesrc/src/UserProfileService.Saga.Worker</code></li> <li>For starting UPS-Sync: <code>../Maverick.UserProfileServicesrc/src/UserProfileService.Sync</code></li> </ul>"},{"location":"Installation/Get%20Started/Single%20Instance/#starting-the-ups-from-an-ide","title":"Starting the UPS from an IDE","text":"<p>To start the UPS with an IDE, you can use either Visual Studio 2022 Community Edition or Rider. Please note that Rider offers only a 30-day trial period. You can open the solution <code>UserProfileService.sln</code> located in the folder <code>../Maverick.UserProfileService</code>.</p>"},{"location":"Introduction/Applied%20Designed%20Patterns/","title":"Applied Designed Pattern","text":"<p>The UPS has evolved over time into a complex service with multiple components that adhere to current architecture and design patterns.</p> <p>Firstly, the service relies on Event-Driven Design (EDD). In EDD, all events related to UPS are stored centrally. An event is an atomic occurrence that propagates a state change. In our case, an event could involve creating, deleting, or modifying an entity (e.g., a user). Data from this central source can be projected into any database and then retrieved. Projection transforms and stores input data into a database-specific format, significantly reducing access times as data doesn't need conversion during reads.</p> <p>Next, the service follows the Command-Query-Responsibility-Segregation (CQRS) pattern. This pattern advocates for splitting object models into separate read and write parts within a database. The advantage of this pattern is improved scalability, as write operations can run on different hardware from read operations.</p> <p>Furthermore, the UPS API supports the Asynchronous Request-Reply Pattern(ARRP). This pattern ensures that the API asynchronously handles data modification requests. The status of these modifications can be queried at any time using a dedicated endpoint. Communication in the command part between components is achieved through queuing. Retrieving an entity from the database still occurs via a REST call. Lastly, the UPS utilizes the Saga pattern, which simplifies data handling in distributed systems.</p>"},{"location":"Introduction/Features/","title":"Features","text":"<ul> <li>Manages user data including their relations</li> <li>Used entities are hierarchically structured and therefore are stored in a graph.   like:<ul> <li>Users are stored in groups</li> <li>Organizations can contain other organizations</li> <li>Users or groups can be assigned to Functions or Roles</li> <li>Functions limit access of their containing role by an additional organization</li> <li>All kind of Assignments can be triggered in the future for an user</li> <li>Volatile Data can be stored in a database and can be used as a container without persisted in the eventstore</li> </ul> </li> <li>Can store the incoming requests in various ways due to its \"data projections\"</li> <li>Contains entity models for roles and functions that can be used as source of a RBAC system or OPA</li> </ul>"},{"location":"Introduction/Licence/","title":"Licence","text":""},{"location":"Introduction/Licence/#we-are-using-following-great-third-party-libraries","title":"We are using following great third-party-libraries","text":"<ul> <li>Automapper</li> <li>MassTransit</li> <li>Marten</li> <li>JsonSubtypes</li> <li>Newtonsoft.Json</li> <li>Swashbuckle</li> <li>Hellang ProblemDetails</li> <li>prometheus-net</li> <li>StackExchange.Redis</li> <li>NLog</li> <li>FluentValidations</li> </ul>"},{"location":"Introduction/Licence/#for-testing","title":"For testing","text":"<ul> <li>XUnit</li> <li>FluentAssertions</li> <li>AutoFixture</li> <li>Bogus</li> <li>Moq</li> </ul>"},{"location":"Troubleshooting/FirstSteps/","title":"First Steps","text":""},{"location":"Troubleshooting/FirstSteps/#troubleshooting-steps-for-service-or-saga-worker","title":"Troubleshooting Steps for Service or Saga-Worker","text":"<p>When encountering issues with a service or Saga-Worker, follow these systematic steps to diagnose and resolve the problem effectively:</p>"},{"location":"Troubleshooting/FirstSteps/#check-service-or-saga-worker-status","title":"Check Service or Saga-Worker Status","text":"<p>Start by verifying if the Service or Saga-Worker is running as expected. If not, proceed with the following steps:</p>"},{"location":"Troubleshooting/FirstSteps/#log-and-configuration-examination","title":"Log and Configuration Examination","text":"<ol> <li>Check Logs and Configuration:</li> <li>Review logs for any errors or anomalies that might indicate why the service is not running.</li> <li>Ensure that the configuration settings are correctly set up and aligned with the service requirements.</li> </ol>"},{"location":"Troubleshooting/FirstSteps/#logging-level-adjustment","title":"Logging Level Adjustment","text":"<p>For deeper insights into the issue, consider increasing the log level to Debug or Trace:</p> <ol> <li>Adjust Log Level:</li> <li>Increase log verbosity to Debug or Trace to gather more detailed information.</li> </ol>"},{"location":"Troubleshooting/FirstSteps/#credentials-verification","title":"Credentials Verification","text":"<ol> <li>Verify Credentials:</li> <li>Double-check credentials used by third-party components to prevent authentication issues.</li> <li>Look out for \"not authorized - 401\" messages in logs as indicators of authentication failures.</li> </ol>"},{"location":"Troubleshooting/FirstSteps/#health-endpoints-analysis","title":"Health-Endpoints Analysis","text":"<ol> <li>Check Health-Endpoints:</li> <li>Utilize health-endpoints to assess the overall system health.<ul> <li>Verify the existence and accessibility of critical components like databases (e.g., ArangDb, Postgres) through state endpoints.</li> <li>Ensure that the correct credentials are used for accessing these components.</li> </ul> </li> </ol>"},{"location":"Troubleshooting/FirstSteps/#log-analysis","title":"Log Analysis","text":"<ol> <li>Review Logs for Context:</li> <li>Analyze logs for additional context, errors, or warnings related to the issue.</li> </ol>"},{"location":"Troubleshooting/FirstSteps/#queue-inspection","title":"Queue Inspection","text":"<ol> <li>Inspect Message Queues:</li> <li>Check for error messages or stalled processes in message queues, especially in asynchronous communication scenarios.</li> </ol> <p>By following these steps in a methodical manner, you can efficiently troubleshoot and resolve issues affecting your service or Saga-Worker, minimizing downtime and ensuring smooth operation.</p>"},{"location":"Troubleshooting/Health/","title":"Health Endpoints","text":"<p>Cloud environments, including Kubernetes, rely on health endpoints to monitor and maintain application performance and availability, enabling automated actions and improving system reliability. The UPS can also run within a cloud-based environment and provide health endpoints. The types of supported health-endpoints are:</p> <ul> <li>Liveness<ul> <li><code>/health/live</code></li> <li>Is the service started and theoretically functional (config/port binding/DLLs loaded)</li> </ul> </li> <li>Readyness<ul> <li><code>/health/ready</code></li> <li>Is the service capable of performing its tasks (processing messages/events/requests)</li> </ul> </li> <li>Status<ul> <li><code>/health/state</code></li> <li>Display additional information from the service</li> </ul> </li> </ul> <p>If the UPS is not running, health endpoints can help identify the issue or serve as the first step in troubleshooting. Below is an example of the /health/state endpoint from the UPS API:</p> Health-Endpoints example state <pre><code>{\n    \"entries\": {\n        \"sagaWorker\": {\n            \"data\": {\n                \"healthy\": 1,\n                \"degraded\": 0,\n                \"unhealthy\": 0,\n                \"version\": \"7.4.4.92\"\n            },\n            \"status\": \"Healthy\"\n        },\n        \"sync\": {\n            \"data\": {\n                \"healthy\": 1,\n                \"degraded\": 0,\n                \"unhealthy\": 0,\n                \"version\": \"7.4.4.92\"\n            },\n            \"status\": \"Healthy\"\n        },\n        \"arangodb-internal\": {\n            \"data\": {\n                \"version\": \"3.9.3\",\n                \"license\": \"community\",\n                \"server\": \"arango\"\n            },\n            \"status\": \"Healthy\"\n        },\n        \"arangoDB\": {\n            \"data\": {\n                \"updatedAt\": \"2024-05-08T12:57:42.9260267Z\",\n                \"failureStatus\": \"Unhealthy\",\n                \"status\": \"Healthy\"\n            },\n            \"status\": \"Healthy\"\n        },\n        \"masstransit-bus\": {\n            \"data\": {\n                \"endpoints\": {\n                    \"rabbitmq://rabbitmq.dev.env.av360.org/maverick.user-profile.api-submit-command-response\": {\n                        \"status\": \"Healthy\",\n                        \"description\": \"ready\"\n                    },\n                    \"rabbitmq://rabbitmq.dev.env.av360.org/maverick.user-profile.api-health-check-message.consumer?temporary=true\": {\n                        \"status\": \"Healthy\",\n                        \"description\": \"ready\"\n                    },\n                    \"rabbitmq://rabbitmq.dev.env.av360.org/f7e26e9d21dc_UserProfileServiceCustom_bus_yryyyyfcncbrfp53bdqgsh19rf?temporary=true\": {\n                        \"status\": \"Healthy\",\n                        \"description\": \"ready (not started)\"\n                    }\n                }\n            },\n            \"status\": \"Healthy\"\n        },\n        \"redis-internal\": {\n            \"data\": {},\n            \"status\": \"Healthy\"\n        },\n        \"redis\": {\n            \"data\": {\n                \"updatedAt\": \"2024-05-08T12:57:42.9260362Z\",\n                \"failureStatus\": \"Degraded\",\n                \"status\": \"Healthy\"\n            },\n            \"status\": \"Healthy\"\n        }\n    },\n    \"status\": \"Healthy\",\n    \"version\": \"7.4.4.92\"\n}\n</code></pre> <p>They display the health status of the utilized third-party components and also show the current version of the service. Additionally, they indicate the health status of the UPS components: the SagaWorker and the Sync. The Sync also offers a <code>health/state</code> endpoint. You can also, of course, utilize the other health endpoints.</p>"},{"location":"Troubleshooting/Known%20Issues/","title":"Known Issues","text":"<p>Some known Issue are:</p> <ul> <li>Operation progress is pending for an entity.</li> <li>Entity cannot be deleted.</li> <li>Inconsistency in the database.</li> <li>Precompiled files in Marten.</li> <li>Sync is syncing users twice or more times.</li> </ul>"}]}